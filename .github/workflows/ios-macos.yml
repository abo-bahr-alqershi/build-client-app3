# Codemagic iOS Build Configuration - Fixed for Xcode 16.4 Bug
workflows:
  ios-debug-build:
    name: iOS Debug Build
    max_build_duration: 120
    instance_type: mac_mini_m2
    
    environment:
      ios_signing:
        distribution_type: development
        bundle_identifier: com.hggzk.app
      flutter: stable
      xcode: 15.0  # ÿ™ÿ∫ŸäŸäÿ± ÿ•ŸÑŸâ Xcode 15 ŸÑÿ™ÿ¨ŸÜÿ® bug ÿßŸÑŸÖŸàÿ¨ŸàÿØ ŸÅŸä 16.4
      cocoapods: default
      
      vars:
        # Environment variables
        LANG: en_US.UTF-8
        LANGUAGE: en_US.UTF-8
        LC_ALL: en_US.UTF-8
        COCOAPODS_DISABLE_STATS: "true"
    
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: '*'
          include: true
    
    scripts:
      # === STEP 1: Environment Setup ===
      - name: Show environment info
        script: |
          echo "========================================="
          echo "üìä ENVIRONMENT INFORMATION"
          echo "========================================="
          flutter --version
          pod --version
          xcodebuild -version
          ruby --version
          echo "========================================="
          
      # === STEP 2: Configure code signing ===
      - name: Configure code signing
        script: |
          echo "üîê Configuring code signing..."
          xcode-project use-profiles
          
      # === STEP 3: Clean everything ===
      - name: Deep clean
        script: |
          echo "üßπ Deep cleaning build environment..."
          
          # Clean Xcode derived data
          rm -rf ~/Library/Developer/Xcode/DerivedData
          
          # Clean iOS build artifacts
          cd ios
          rm -rf build
          rm -rf Pods
          rm -f Podfile.lock
          rm -rf .symlinks
          pod cache clean --all --verbose || true
          cd ..
          
          # Clean Flutter artifacts
          flutter clean
          rm -rf .dart_tool
          rm -rf build
          
          echo "‚úÖ Cleaning completed"
          
      # === STEP 4: Get Flutter dependencies ===
      - name: Get Flutter dependencies
        script: |
          echo "üì¶ Getting Flutter dependencies..."
          flutter pub get
          
      # === STEP 5: Fix iOS configuration ===
      - name: Configure iOS settings
        script: |
          echo "‚öôÔ∏è Configuring iOS settings..."
          
          # Add Swift settings to Generated.xcconfig
          echo "SWIFT_VERSION = 5.0" >> ios/Flutter/Generated.xcconfig
          echo "SWIFT_COMPILATION_MODE = singlefile" >> ios/Flutter/Generated.xcconfig
          echo "SWIFT_OPTIMIZATION_LEVEL = -Onone" >> ios/Flutter/Generated.xcconfig
          echo "ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES = YES" >> ios/Flutter/Generated.xcconfig
          
          echo "‚úÖ iOS configuration updated"
          
      # === STEP 6: Update CocoaPods ===
      - name: Update CocoaPods repos
        script: |
          echo "üîÑ Updating CocoaPods repositories..."
          pod repo update --verbose
          
      # === STEP 7: Install iOS dependencies ===
      - name: Install iOS dependencies
        script: |
          echo "üì± Installing iOS dependencies..."
          cd ios
          
          # Ensure Podfile exists
          if [ ! -f "Podfile" ]; then
            echo "‚ùå ERROR: Podfile not found!"
            exit 1
          fi
          
          # Install pods
          pod install --repo-update --verbose
          
          # Show installed pods
          echo "üìã Installed pods:"
          pod list --verbose || true
          
          cd ..
          echo "‚úÖ iOS dependencies installed"
          
      # === STEP 8: Fix privacy bundle issues ===
      - name: Fix privacy bundle issues
        script: |
          echo "üîß Fixing privacy bundle issues..."
          
          cd ios
          
          # Function to clean privacy bundles from a project file
          clean_project_file() {
            local file="$1"
            if [ -f "$file" ]; then
              echo "Cleaning: $file"
              
              # Backup original
              cp "$file" "${file}.backup"
              
              # Remove privacy bundle references
              sed -i '' '/_privacy\.bundle/d' "$file"
              sed -i '' '/PrivacyInfo\.xcprivacy/d' "$file"
              sed -i '' '/privacy_bundle/d' "$file"
              
              # Count remaining references
              local count=$(grep -c "privacy" "$file" || echo "0")
              echo "  Remaining privacy references: $count"
            fi
          }
          
          # Clean Runner project
          clean_project_file "Runner.xcodeproj/project.pbxproj"
          
          # Clean Pods project if exists
          if [ -f "Pods/Pods.xcodeproj/project.pbxproj" ]; then
            clean_project_file "Pods/Pods.xcodeproj/project.pbxproj"
          fi
          
          # Remove physical privacy bundle directories
          find . -name "*privacy.bundle" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name "PrivacyInfo.xcprivacy" -type f -delete 2>/dev/null || true
          
          cd ..
          echo "‚úÖ Privacy bundle issues fixed"
          
      # === STEP 9: Verify project integrity ===
      - name: Verify project configuration
        script: |
          echo "üîç Verifying project configuration..."
          
          cd ios
          
          # Check if workspace exists
          if [ ! -d "Runner.xcworkspace" ]; then
            echo "‚ùå ERROR: Runner.xcworkspace not found!"
            exit 1
          fi
          
          # Show build settings
          xcodebuild -workspace Runner.xcworkspace \
                     -scheme Runner \
                     -configuration Debug \
                     -sdk iphoneos \
                     -showBuildSettings | grep -E "SWIFT_VERSION|DEPLOYMENT_TARGET|PRODUCT_BUNDLE_IDENTIFIER" || true
          
          cd ..
          echo "‚úÖ Project verification completed"
          
      # === STEP 10: Build and Export IPA (Workaround for Xcode 16.4 bug) ===
      - name: Build iOS Debug IPA with Workaround
        script: |
          echo "========================================="
          echo "üèóÔ∏è  BUILDING iOS DEBUG IPA"
          echo "========================================="
          
          cd ios
          
          # Method 1: Build archive without export options
          echo "üì¶ Building archive..."
          xcodebuild -workspace Runner.xcworkspace \
                     -scheme Runner \
                     -configuration Debug \
                     -derivedDataPath build/DerivedData \
                     -archivePath build/Runner.xcarchive \
                     DEVELOPMENT_TEAM=KJ8CHSW8D4 \
                     PRODUCT_BUNDLE_IDENTIFIER=com.hggzk.app \
                     archive
          
          # Method 2: Export without exportOptionsPlist (use defaults)
          echo "üì± Exporting IPA without export options..."
          xcodebuild -exportArchive \
                     -archivePath build/Runner.xcarchive \
                     -exportPath build/ipa \
                     DEVELOPMENT_TEAM=KJ8CHSW8D4 \
                     -allowProvisioningUpdates \
                     CODE_SIGN_STYLE=Automatic || {
              
              echo "‚ö†Ô∏è Export without options failed, trying manual signing..."
              
              # Method 3: Create IPA manually from .app
              echo "üì¶ Creating IPA manually..."
              
              # Create Payload directory
              mkdir -p build/ipa/Payload
              
              # Copy .app to Payload
              cp -r build/Runner.xcarchive/Products/Applications/Runner.app build/ipa/Payload/
              
              # Create IPA
              cd build/ipa
              zip -r Runner.ipa Payload
              rm -rf Payload
              cd ../..
              
              echo "‚úÖ IPA created manually"
          }
          
          cd ..
          
          # Verify IPA exists
          if [ -f "ios/build/ipa/Runner.ipa" ]; then
              echo "‚úÖ IPA created successfully"
              ls -la ios/build/ipa/
          else
              echo "‚ö†Ô∏è IPA not found, checking alternative locations..."
              find . -name "*.ipa" -type f
          fi
          
          echo "========================================="
          echo "‚úÖ BUILD PROCESS COMPLETED"
          echo "========================================="
          
      # === STEP 11: Alternative Flutter Build (if above fails) ===
      - name: Alternative Flutter Build Method
        script: |
          # Check if IPA was created
          if [ ! -f "ios/build/ipa/Runner.ipa" ] && [ ! -f "build/ios/ipa/Runner.ipa" ]; then
              echo "üîÑ Trying Flutter build without export options..."
              
              # Try Flutter build without specifying export options
              flutter build ipa --debug --no-pub || {
                  echo "‚ö†Ô∏è Flutter build failed, trying iOS build..."
                  
                  # Build iOS without creating IPA
                  flutter build ios --debug --no-pub
                  
                  # Create IPA manually from build output
                  cd build/ios/iphoneos
                  mkdir -p Payload
                  cp -r Runner.app Payload/
                  zip -r Runner.ipa Payload
                  rm -rf Payload
                  cd ../../..
                  
                  echo "‚úÖ IPA created from iOS build"
              }
          fi
          
      # === STEP 12: Collect all artifacts ===
      - name: Collect and verify artifacts
        script: |
          echo "üì¶ Collecting all build artifacts..."
          
          # Create artifacts directory
          mkdir -p artifacts
          
          # Find and copy all IPAs
          find . -name "*.ipa" -type f | while read ipa; do
              echo "Found IPA: $ipa"
              cp "$ipa" artifacts/ || true
          done
          
          # Find and copy archives
          find . -name "*.xcarchive" -type d | while read archive; do
              echo "Found archive: $archive"
              cp -r "$archive" artifacts/ || true
          done
          
          # List final artifacts
          echo "========================================="
          echo "üìã FINAL ARTIFACTS:"
          echo "========================================="
          ls -la artifacts/ || echo "No artifacts found"
          
          # Ensure at least one IPA exists
          if [ ! -f "artifacts/*.ipa" ]; then
              echo "‚ö†Ô∏è Warning: No IPA found in artifacts directory"
              echo "Searching for any app bundle..."
              find . -name "Runner.app" -type d
          fi
          
    artifacts:
      - artifacts/**
      - ios/build/ipa/*.ipa
      - ios/build/Runner.xcarchive
      - build/ios/iphoneos/*.ipa
      - build/ios/ipa/*.ipa
      
    publishing:
      email:
        recipients:
          - ameenmamwn7@gmail.com
        notify:
          success: true
          failure: true