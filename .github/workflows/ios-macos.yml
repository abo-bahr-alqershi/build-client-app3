name: iOS (macOS)

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'Enable SSH debug session (tmate). Only works for workflow_dispatch.'
        type: boolean
        required: false
        default: false

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      COCOAPODS_DISABLE_STATS: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: SSH debug (tmate)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.ssh }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: Flutter version
        run: flutter --version

      - name: Install CocoaPods
        run: |
          if ! command -v pod >/dev/null; then
            sudo gem install cocoapods
          fi
          pod --version

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile', 'pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Flutter clean
        run: flutter clean

      - name: Flutter pub get
        run: flutter pub get

      # - name: Run tests
      #   run: flutter test

      - name: Pod install
        run: |
          rm -rf ios/Pods ios/Podfile.lock ios/.symlinks
          cd ios
          pod install --repo-update

      - name: Build iOS (PR - no codesign)
        if: ${{ github.event_name == 'pull_request' }}
        run: flutter build ios --release --no-codesign

      - name: Setup iOS code signing (keychain + provisioning profile)
        if: ${{ github.event_name != 'pull_request' }}
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          
          # تنظيف كلمات المرور من أي مسافات أو أحرف خفية
          IOS_P12_PASSWORD_CLEAN="$(printf %s "$IOS_P12_PASSWORD" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
          KEYCHAIN_PASSWORD_CLEAN="$(printf %s "$KEYCHAIN_PASSWORD" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
          
          # التحقق من وجود Secrets
          if [ -z "${IOS_P12_BASE64:-}" ]; then
            echo "❌ Missing secret: IOS_P12_BASE64"
            echo "Please add your p12 file as base64 to GitHub Secrets"
            echo "Run: base64 -i cer_ios/ios_development.p12 | pbcopy"
            exit 1
          fi
          if [ -z "${IOS_P12_PASSWORD_CLEAN:-}" ]; then
            echo "❌ Missing or empty secret: IOS_P12_PASSWORD"
            exit 1
          fi
          if [ -z "${KEYCHAIN_PASSWORD_CLEAN:-}" ]; then
            echo "❌ Missing or empty secret: IOS_KEYCHAIN_PASSWORD"
            exit 1
          fi
          
          # فك تشفير ملف p12 من base64
          CERT_P12="$RUNNER_TEMP/cert.p12"
          echo "$IOS_P12_BASE64" | base64 --decode > "$CERT_P12"
          
          echo "✅ Decoded p12 certificate from base64"
          ls -lh "$CERT_P12"
          
          # التحقق من صحة الملف
          if ! file "$CERT_P12" | grep -q "data"; then
            echo "❌ Decoded file is not valid binary data"
            file "$CERT_P12"
            exit 1
          fi
          
          # اختبار كلمة المرور مع OpenSSL أولاً
          echo "--- Testing password with OpenSSL ---"
          if openssl pkcs12 -in "$CERT_P12" -noout -info -passin pass:"$IOS_P12_PASSWORD_CLEAN" 2>&1 | head -10; then
            echo "✅ OpenSSL: Password is correct"
          else
            echo "❌ OpenSSL: Password verification failed"
            echo "This indicates the password in IOS_P12_PASSWORD secret is incorrect"
            exit 1
          fi
          
          # إنشاء keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          security list-keychains -d user -s build.keychain
          
          # طريقة محسّنة لاستيراد الشهادة (حل مشكلة security import مع كلمات المرور)
          # استخدام OpenSSL لاستخراج الشهادة والمفتاح ثم إعادة استيرادهم
          echo "--- Extracting certificate and private key ---"
          
          CERT_PEM="$RUNNER_TEMP/cert.pem"
          KEY_PEM="$RUNNER_TEMP/key.pem"
          NEW_P12="$RUNNER_TEMP/cert_reimported.p12"
          
          # استخراج الشهادة
          openssl pkcs12 -in "$CERT_P12" -clcerts -nokeys -out "$CERT_PEM" \
            -passin pass:"$IOS_P12_PASSWORD_CLEAN" -passout pass:
          
          # استخراج المفتاح الخاص
          openssl pkcs12 -in "$CERT_P12" -nocerts -out "$KEY_PEM" \
            -passin pass:"$IOS_P12_PASSWORD_CLEAN" -passout pass:tempkey123
          
          # إعادة تصدير p12 بدون كلمة مرور (أكثر توافقاً مع security)
          openssl pkcs12 -export -out "$NEW_P12" \
            -inkey "$KEY_PEM" -in "$CERT_PEM" \
            -passin pass:tempkey123 -passout pass:
          
          echo "✅ Re-exported certificate without password for compatibility"
          
          # استيراد الشهادة المُعاد تصديرها
          if security import "$NEW_P12" -k build.keychain -P "" -A; then
            echo "✅ Successfully imported certificate to keychain"
          else
            echo "❌ Failed to import certificate"
            exit 1
          fi
          
          # إعداد keychain للاستخدام
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          
          echo "--- Code signing identities ---"
          security find-identity -v -p codesigning build.keychain
          
          # معالجة provisioning profile
          PROFILE="cer_ios/Provision_Profile_2.mobileprovision"
          if [ ! -f "$PROFILE" ]; then
            echo "❌ Missing provisioning profile: $PROFILE"
            exit 1
          fi
          
          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PROFILE" > "$PROFILE_PLIST"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$PROFILE_PLIST")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$PROFILE_PLIST")
          TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' "$PROFILE_PLIST")
          
          echo "Profile Name: $PROFILE_NAME"
          echo "Team ID: $TEAM_ID"
          echo "PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"
          echo "TEAM_ID=$TEAM_ID" >> "$GITHUB_ENV"
          
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"
          
          echo "✅ iOS code signing setup completed successfully"

      - name: Build IPA (Release)
        if: ${{ github.event_name != 'pull_request' }}
        env:
          BUNDLE_ID: com.hggzk.app
        run: |
          set -euo pipefail

          EXPORT_OPTIONS_PLIST="$RUNNER_TEMP/ExportOptions.plist"
          cat > "$EXPORT_OPTIONS_PLIST" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key>
              <string>${PROFILE_NAME}</string>
            </dict>
          </dict>
          </plist>
          EOF

          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath build/Runner.xcarchive \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            archive

          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" \
            -exportPath build/ipa

          ls -la build/ipa

      - name: Upload IPA artifact
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ipa/*.ipa
