name: iOS (macOS)

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'Enable SSH debug session (tmate). Only works for workflow_dispatch.'
        type: boolean
        required: false
        default: false

jobs:
  ios-build:
    runs-on: macos-latest
    timeout-minutes: 60
    env:
      COCOAPODS_DISABLE_STATS: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: SSH debug (tmate)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.ssh }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

      - name: Flutter version
        run: flutter --version

      - name: Install CocoaPods
        run: |
          if ! command -v pod >/dev/null; then
            sudo gem install cocoapods
          fi
          pod --version

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile', 'pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Flutter clean
        run: flutter clean

      - name: Flutter pub get
        run: flutter pub get

      # - name: Run tests
      #   run: flutter test

      - name: Pod install
        run: |
          rm -rf ios/Pods ios/Podfile.lock ios/.symlinks
          cd ios
          pod install --repo-update

      - name: Build iOS (PR - no codesign)
        if: ${{ github.event_name == 'pull_request' }}
        run: flutter build ios --release --no-codesign

      - name: Setup iOS code signing (keychain + provisioning profile)
        if: ${{ github.event_name != 'pull_request' }}
        env:
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          
          # ØªÙ†Ø¸ÙŠÙ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† Ø£ÙŠ Ù…Ø³Ø§ÙØ§Øª Ø£Ùˆ Ø£Ø­Ø±Ù Ø®ÙÙŠØ©
          IOS_P12_PASSWORD_CLEAN="$(printf %s "$IOS_P12_PASSWORD" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
          KEYCHAIN_PASSWORD_CLEAN="$(printf %s "$KEYCHAIN_PASSWORD" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Secrets
          if [ -z "${IOS_P12_PASSWORD_CLEAN:-}" ]; then
            echo "âŒ Missing or empty secret: IOS_P12_PASSWORD"
            exit 1
          fi
          if [ -z "${KEYCHAIN_PASSWORD_CLEAN:-}" ]; then
            echo "âŒ Missing or empty secret: IOS_KEYCHAIN_PASSWORD"
            exit 1
          fi
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±ÙŠØ¨Ùˆ Ù…Ø¨Ø§Ø´Ø±Ø©
          CERT_P12="cer_ios/ios_development.p12"
          PROFILE="cer_ios/Provision_Profile_2.mobileprovision"
          
          if [ ! -f "$CERT_P12" ]; then
            echo "âŒ Missing certificate file: $CERT_P12"
            exit 1
          fi
          if [ ! -f "$PROFILE" ]; then
            echo "âŒ Missing provisioning profile: $PROFILE"
            exit 1
          fi
          
          echo "--- Certificate file info ---"
          ls -lh "$CERT_P12"
          file "$CERT_P12"
          shasum -a 256 "$CERT_P12"
          
          # Ø§Ø®ØªØ¨Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø¹ OpenSSL Ø£ÙˆÙ„Ø§Ù‹
          echo ""
          echo "--- Testing password with OpenSSL ---"
          if openssl pkcs12 -in "$CERT_P12" -noout -info -passin pass:"$IOS_P12_PASSWORD_CLEAN" 2>&1 | head -10; then
            echo "âœ… OpenSSL: Password verified successfully"
          else
            echo "âŒ OpenSSL: Password verification failed"
            exit 1
          fi
          
          # Ø¥Ù†Ø´Ø§Ø¡ keychain
          echo ""
          echo "--- Creating keychain ---"
          security create-keychain -p "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          security list-keychains -d user -s build.keychain
          echo "âœ… Keychain created and configured"
          
          # Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙˆØ§Ù„Ù…ÙØªØ§Ø­ Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ (PEM format)
          echo ""
          echo "--- Extracting certificate and private key (PEM format) ---"
          
          CERT_PEM="$RUNNER_TEMP/cert.pem"
          KEY_PEM="$RUNNER_TEMP/key.pem"
          CA_CERTS="$RUNNER_TEMP/ca.pem"
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
          openssl pkcs12 -in "$CERT_P12" -clcerts -nokeys -out "$CERT_PEM" \
            -passin pass:"$IOS_P12_PASSWORD_CLEAN"
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ (Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… -nodes)
          openssl pkcs12 -in "$CERT_P12" -nocerts -nodes -out "$KEY_PEM" \
            -passin pass:"$IOS_P12_PASSWORD_CLEAN"
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ CA certificates (Ø¥Ù† ÙˆÙØ¬Ø¯Øª)
          openssl pkcs12 -in "$CERT_P12" -cacerts -nokeys -out "$CA_CERTS" \
            -passin pass:"$IOS_P12_PASSWORD_CLEAN" 2>/dev/null || true
          
          echo "âœ… Extracted certificate and key to PEM format"
          ls -lh "$CERT_PEM" "$KEY_PEM"
          
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„Ù€ keychain
          echo ""
          echo "--- Importing certificate to keychain ---"
          if security import "$CERT_PEM" -k build.keychain -T /usr/bin/codesign -T /usr/bin/security; then
            echo "âœ… Certificate imported"
          else
            echo "âŒ Certificate import failed"
            exit 1
          fi
          
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ Ù„Ù„Ù€ keychain
          echo "--- Importing private key to keychain ---"
          if security import "$KEY_PEM" -k build.keychain -T /usr/bin/codesign -T /usr/bin/security -A; then
            echo "âœ… Private key imported"
          else
            echo "âŒ Private key import failed"
            exit 1
          fi
          
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ CA certificates Ø¥Ù† ÙˆÙØ¬Ø¯Øª
          if [ -s "$CA_CERTS" ]; then
            echo "--- Importing CA certificates ---"
            security import "$CA_CERTS" -k build.keychain -T /usr/bin/codesign -T /usr/bin/security 2>/dev/null || echo "âš ï¸  CA import skipped"
          fi
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØµÙˆÙ„
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          
          echo ""
          echo "--- Code signing identities ---"
          security find-identity -v -p codesigning build.keychain
          
          # Ù…Ø¹Ø§Ù„Ø¬Ø© provisioning profile
          echo ""
          echo "--- Installing provisioning profile ---"
          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          security cms -D -i "$PROFILE" > "$PROFILE_PLIST"
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$PROFILE_PLIST")
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$PROFILE_PLIST")
          TEAM_ID=$(/usr/libexec/PlistBuddy -c 'Print :TeamIdentifier:0' "$PROFILE_PLIST")
          
          # Ø§ÙƒØªØ´Ø§Ù Ù†ÙˆØ¹ provisioning profile ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          echo "--- Detecting provisioning profile type ---"
          
          HAS_DEVICES="false"
          GET_TASK_ALLOW="unknown"
          
          if /usr/libexec/PlistBuddy -c 'Print :ProvisionedDevices' "$PROFILE_PLIST" &>/dev/null; then
            HAS_DEVICES="true"
            DEVICE_COUNT=$(/usr/libexec/PlistBuddy -c 'Print :ProvisionedDevices' "$PROFILE_PLIST" 2>/dev/null | grep -c "Dict" || echo "0")
            echo "ProvisionedDevices: YES (count: $DEVICE_COUNT)"
          else
            echo "ProvisionedDevices: NO (App Store profile)"
          fi
          
          GET_TASK_ALLOW_VALUE=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:get-task-allow' "$PROFILE_PLIST" 2>/dev/null || echo "not_found")
          echo "get-task-allow: $GET_TASK_ALLOW_VALUE"
          
          if [ "$HAS_DEVICES" = "true" ]; then
            if [ "$GET_TASK_ALLOW_VALUE" = "true" ]; then
              EXPORT_METHOD="development"
              echo "âœ… Detected: Development provisioning profile"
            else
              EXPORT_METHOD="ad-hoc"
              echo "âœ… Detected: Ad-Hoc provisioning profile"
            fi
          else
            EXPORT_METHOD="app-store"
            echo "âœ… Detected: App Store provisioning profile"
          fi
          
          echo "Profile Name: $PROFILE_NAME"
          echo "Profile UUID: $PROFILE_UUID"
          echo "Team ID: $TEAM_ID"
          echo "Export Method: $EXPORT_METHOD"
          
          echo "PROFILE_NAME=$PROFILE_NAME" >> "$GITHUB_ENV"
          echo "PROFILE_UUID=$PROFILE_UUID" >> "$GITHUB_ENV"
          echo "TEAM_ID=$TEAM_ID" >> "$GITHUB_ENV"
          echo "EXPORT_METHOD=$EXPORT_METHOD" >> "$GITHUB_ENV"
          
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"
          
          echo ""
          echo "âœ… iOS code signing setup completed successfully"

      - name: Build IPA (Release)
        if: ${{ github.event_name != 'pull_request' }}
        env:
          BUNDLE_ID: com.hggzk.app
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail
          
          # ØªÙ†Ø¸ÙŠÙ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± keychain
          KEYCHAIN_PASSWORD_CLEAN="$(printf %s "$KEYCHAIN_PASSWORD" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
          echo "--- Build Configuration ---"
          echo "Bundle ID (expected): $BUNDLE_ID"
          echo "Team ID: ${TEAM_ID:-NOT_SET}"
          echo "Profile Name: ${PROFILE_NAME:-NOT_SET}"
          echo "Profile UUID: ${PROFILE_UUID:-NOT_SET}"
          echo "Export Method: ${EXPORT_METHOD:-NOT_SET}"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† bundle ID ÙÙŠ provisioning profile
          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          if [ -f "$PROFILE_PLIST" ]; then
            PROFILE_BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :Entitlements:application-identifier' "$PROFILE_PLIST" 2>/dev/null | sed "s/${TEAM_ID}\.//" || echo "NOT_FOUND")
            echo "Bundle ID (in profile): $PROFILE_BUNDLE_ID"
            
            if [ "$PROFILE_BUNDLE_ID" != "$BUNDLE_ID" ] && [ "$PROFILE_BUNDLE_ID" != "*" ] && [ "$PROFILE_BUNDLE_ID" != "NOT_FOUND" ]; then
              echo "âš ï¸  Warning: Bundle ID mismatch!"
              echo "  Expected: $BUNDLE_ID"
              echo "  Profile has: $PROFILE_BUNDLE_ID"
            fi
          fi
          echo ""
          
          if [ -z "${EXPORT_METHOD:-}" ]; then
            echo "âŒ EXPORT_METHOD not set, defaulting to development"
            EXPORT_METHOD="development"
          fi
          if [ -z "${TEAM_ID:-}" ]; then
            echo "âŒ TEAM_ID not set"
            exit 1
          fi
          if [ -z "${PROFILE_UUID:-}" ]; then
            echo "âŒ PROFILE_UUID not set"
            exit 1
          fi
          echo ""
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ signing identity Ù…Ù† Ø§Ù„Ù€ keychain
          echo "--- Available signing identities ---"
          security find-identity -v -p codesigning build.keychain
          echo ""
          
          SIGNING_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Apple Development" | head -1 | sed -E 's/.*"(.+)".*/\1/')
          
          if [ -z "$SIGNING_IDENTITY" ]; then
            echo "âŒ Failed to extract signing identity"
            exit 1
          fi
          
          echo "Extracted Signing Identity: '$SIGNING_IDENTITY'"
          echo ""

          # ========== Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù…Ø´ÙƒÙ„Ø© Xcode 16.4 ==========
          # Xcode 16.4 Bug Fix: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±Ù‚ Ø¨Ø¯ÙŠÙ„Ø© Ù„Ù„ØªØµØ¯ÙŠØ±
          
          echo "--- Building Archive ---"
          xcodebuild -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath build/Runner.xcarchive \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            archive

          echo ""
          echo "--- Archive created successfully ---"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­ØªÙˆÙ‰ Archive
          if [ -f "build/Runner.xcarchive/Info.plist" ]; then
            echo "Archive Info.plist:"
            plutil -p "build/Runner.xcarchive/Info.plist" | grep -E "ApplicationProperties|CFBundleIdentifier|SigningIdentity" || true
          fi
          
          if [ -d "build/Runner.xcarchive/Products/Applications/Runner.app" ]; then
            echo ""
            echo "Runner.app Info.plist:"
            plutil -p "build/Runner.xcarchive/Products/Applications/Runner.app/Info.plist" | grep -E "CFBundleIdentifier|CFBundleVersion|CFBundleShortVersionString" || true
            echo ""
            echo "Runner.app codesign info:"
            codesign -dv "build/Runner.xcarchive/Products/Applications/Runner.app" 2>&1 | grep -E "Authority|TeamIdentifier|Identifier" || true
          fi
          
          echo ""
          echo "--- Exporting IPA (Xcode 16.4 Workaround) ---"
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† keychain Ù‡Ùˆ default
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD_CLEAN" build.keychain
          echo "âœ… Keychain unlocked and set as default"
          
          # ========== XCODE 16.4 BUG FIX - Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ø¶Ù…ÙˆÙ† ==========
          # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ø³ØªØ®Ø¯Ø§Ù… Automatic Detection Ø¨Ø¯ÙˆÙ† ExportOptions.plist
          echo ""
          echo "ğŸ”§ Using Xcode 16.4 Fix: Automatic Export Detection"
          echo "--- Attempting automatic export (no ExportOptions.plist) ---"
          
          # Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ù„ÙØ§Øª ExportOptions Ù‚Ø¯ÙŠÙ…Ø©
          rm -rf build/ipa 2>/dev/null || true
          mkdir -p build/ipa
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ø¯ÙˆÙ† ExportOptions.plist - Ø¯Ø¹ Xcode ÙŠÙƒØªØ´Ù ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          set +e
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -allowProvisioningUpdates \
            2>&1 | tee /tmp/export_auto.log
          AUTO_EXPORT_EXIT_CODE=$?
          set -e
          
          if [ $AUTO_EXPORT_EXIT_CODE -eq 0 ]; then
            echo "âœ… Export succeeded with automatic detection!"
          else
            echo "âš ï¸  Automatic export failed, trying alternative method"
            echo ""
            
            # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø§Ø³ØªØ®Ø¯Ø§Ù… xcrun xcodebuild Ù…Ø¹ minimal ExportOptions
            echo "ğŸ”§ Using Alternative Method: xcrun with minimal options"
            
            # Ø¥Ù†Ø´Ø§Ø¡ minimal ExportOptions.plist
            MINIMAL_EXPORT_OPTIONS="$RUNNER_TEMP/MinimalExportOptions.plist"
            
            # Ø¥Ù†Ø´Ø§Ø¡ plist Ø¨Ø³ÙŠØ· Ø¬Ø¯Ø§Ù‹ ÙÙ‚Ø· Ø¨Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ§Øª
            cat > "$MINIMAL_EXPORT_OPTIONS" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>compileBitcode</key>
  <false/>
</dict>
</plist>
EOF
            
            echo "Minimal ExportOptions.plist:"
            cat "$MINIMAL_EXPORT_OPTIONS"
            echo ""
            
            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ù…Ø¹ minimal options
            set +e
            xcrun xcodebuild -exportArchive \
              -archivePath build/Runner.xcarchive \
              -exportOptionsPlist "$MINIMAL_EXPORT_OPTIONS" \
              -exportPath build/ipa \
              2>&1 | tee /tmp/export_minimal.log
            MINIMAL_EXPORT_EXIT_CODE=$?
            set -e
            
            if [ $MINIMAL_EXPORT_EXIT_CODE -eq 0 ]; then
              echo "âœ… Export succeeded with minimal options!"
            else
              echo "âš ï¸  Minimal export failed, trying legacy method"
              echo ""
              
              # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø§Ø³ØªØ®Ø¯Ø§Ù… Legacy export Ù…Ø¹ automatic signing
              echo "ğŸ”§ Using Legacy Method: Rebuild with automatic signing"
              
              # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¹ automatic signing
              echo "--- Rebuilding archive with automatic signing ---"
              xcodebuild -workspace ios/Runner.xcworkspace \
                -scheme Runner \
                -configuration Release \
                -sdk iphoneos \
                -destination 'generic/platform=iOS' \
                -archivePath build/RunnerAuto.xcarchive \
                DEVELOPMENT_TEAM="$TEAM_ID" \
                archive
              
              # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒØ§Ù…Ù„
              echo "--- Exporting with full automatic detection ---"
              set +e
              xcodebuild -exportArchive \
                -archivePath build/RunnerAuto.xcarchive \
                -exportPath build/ipa \
                2>&1 | tee /tmp/export_full_auto.log
              FULL_AUTO_EXIT_CODE=$?
              set -e
              
              if [ $FULL_AUTO_EXIT_CODE -eq 0 ]; then
                echo "âœ… Export succeeded with full automatic signing!"
              else
                echo "âŒ All export methods failed"
                echo ""
                echo "--- Debug information ---"
                echo "Last error from automatic export:"
                tail -20 /tmp/export_full_auto.log | grep -i "error\|fail" || true
                echo ""
                echo "--- Archive contents ---"
                ls -la build/Runner.xcarchive/Products/Applications/
                echo ""
                echo "--- Provisioning profiles ---"
                ls -la "$HOME/Library/MobileDevice/Provisioning Profiles/" || true
                echo ""
                echo "âš ï¸  FINAL FALLBACK: Creating IPA manually"
                
                # Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©: Ø¥Ù†Ø´Ø§Ø¡ IPA ÙŠØ¯ÙˆÙŠØ§Ù‹
                echo "--- Creating IPA manually ---"
                mkdir -p build/ipa/Payload
                cp -R build/Runner.xcarchive/Products/Applications/Runner.app build/ipa/Payload/
                cd build/ipa
                zip -r Runner.ipa Payload
                rm -rf Payload
                cd ../..
                
                if [ -f "build/ipa/Runner.ipa" ]; then
                  echo "âœ… IPA created manually successfully!"
                else
                  echo "âŒ Failed to create IPA manually"
                  exit 1
                fi
              fi
            fi
          fi
          
          echo ""
          echo "--- Export completed ---"
          ls -la build/ipa/
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ IPA
          if ls build/ipa/*.ipa 1> /dev/null 2>&1; then
            echo "âœ… IPA file(s) found:"
            ls -lh build/ipa/*.ipa
            
            # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† IPA
            for ipa in build/ipa/*.ipa; do
              echo ""
              echo "--- IPA Info: $(basename "$ipa") ---"
              unzip -l "$ipa" | head -20
            done
          else
            echo "âŒ No IPA files found in build/ipa/"
            ls -la build/ipa/
            exit 1
          fi

      - name: Upload IPA artifact
        if: ${{ github.event_name != 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ipa/*.ipa